# 1) What is the total amount each customer spent at the restaurant?
Select s.customer_id as Customer, sum(m.price) as total_bill 
from sales  s join  menu m 
on s.product_id=m.product_id 
group by Customer;

# 2) How many days has each customer visited the restaurant?
Select customer_id, count(distinct(order_date)) as no_of_visits 
from sales 
group by customer_id;

# 3) What was the first item from the menu purchased by each customer?
with cte as(select s.customer_id,s.product_id,m.product_name, 
rank() over (partition by s.customer_id order by s.order_date asc)rnk
FROM sales s join menu m
on s.product_id=m.product_id)
select cte.customer_id,cte.product_name,cte.product_id  from cte where rnk=1;

# 4) What is the most purchased item on the menu and how many times was it purchased by all customers?
select m.product_name, count(s.customer_id)as times_purchased
from sales s join menu m 
on s.product_id=m.product_id
group by m.product_id
order by times_purchased desc limit 1;

# 5) Which item was the most popular for each customer?
with cte as
(
	select sales.customer_id, menu.product_name, count(sales.product_id) as Total_Purchased,
	ROW_NUMBER() over(partition by sales.customer_id order by count(sales.product_id) desc) as Rows
	from sales
	inner join menu on sales.product_id=menu.product_id
	group by sales.customer_id, menu.product_name
)
select cte.customer_id, cte.product_name as MostPop
from cte
where Rows = 1;

# 6) Which item was purchased first by the customer after they became a member?
with cte as (
select s.*,datediff(s.order_date, me.join_date) as datedif
from sales s join members me on 
s.customer_id = me.customer_id
)
select cte.customer_id,m.product_id,m.product_name , min(cte.datedif)
from cte inner join menu m on cte.product_id=m.product_id where cte.datedif>0 group by cte.customer_id;

# 7) Which item was purchased just before the customer became a member?
with cte as (
select s.*,datediff(s.order_date, me.join_date) as datedif
from sales s join members me on 
s.customer_id = me.customer_id
)
select cte.customer_id,m.product_id,m.product_name , max(cte.datedif)
from cte inner join menu m on cte.product_id=m.product_id where cte.datedif<0 group by cte.customer_id;

#  8) What is the total items and amount spent for each member before they became a member?

with cte as (
select s.*,datediff(s.order_date, me.join_date) as datedif
from sales s join members me on 
s.customer_id = me.customer_id
)
select cte.customer_id, sum(m.price)as totalprice
from cte inner join menu m on cte.product_id=m.product_id where cte.datedif<0 group by cte.customer_id;

# 9) If each $1 spent equates to 10 points and sushi has a 2x points multiplier - how many points would each customer have?
with cte as(select m.pr oduct_id,
case
when m.product_name="curry" then m.price*10
when m.product_name="sushi" then m.price*10*2
when m.product_name="ramen" then m.price*10
end as points
from  menu m)
select s.customer_id,sum(cte.points)as total_points from cte join sales s
on s.product_id=cte.product_id  group by s.customer_id;

# 10) In the first week after a customer joins the program (including their join date) they earn 2x points on all items, not just sushi - how many points do customer A and B have at the end of January?
with dates as (
	select 
		me.*, s.*,datediff(s.order_date, me.join_date) as datedif,
me.join_date + 7 as first_week from sales s join members me on 
s.customer_id = me.customer_id
)
	select d.customer_id,
		SUM(case when s. order_date < d.first_week  then (m.price * 10 * 2) else (m.price * 10) end ) as points_eoj
	from dates d join menu m on m.product_id=d.product_id 
    where d.datedif>0
	group by d. customer_id ;
